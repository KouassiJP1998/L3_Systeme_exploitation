#include "shm-common.h"

int createId(const char *PATHNAME, int PROJ_ID, char *arg, int server){
    int shmid;
    key_t key;

    /*Création de la clé*/
    key = ftok(PATHNAME, PROJ_ID);
    if(key < 0){
      fprintf(stderr," %s:%s:%d: Unable to create the System V IPC key from the \"%s\" pathname and the \"%d\" project identifier.\n", arg,__FILE__,__LINE__,PATHNAME,PROJ_ID);
      exit(1);
    }

    /*Identifiant du segment de mémoire partagée (key), de taille SHMSIZE, droit de lecture et écriture dans le segment (0600) uniquement à l'utilisateur*/
    if (server){
        shmid = shmget(key,sizeof(shm_message_t), IPC_CREAT | IPC_EXCL | 0600 );
    } else {
        shmid = shmget(key,sizeof(shm_message_t), 0600 );
    }

    if (shmid < 0) {
      fprintf(stderr, " %s:%s:%d: Unable to get the identifier of the System V shared memory segment from the \"0x%08x\" key. \n", arg,__FILE__,__LINE__,key);
      exit(1);
    }
    return(shmid);
}

shm_message_t* createpShmMessage(const char *PATHNAME, int PROJ_ID, char *arg, int server){
    shm_message_t *pShmMessage;
    int shmid;

    printf("proj_id = \"%d\"\n",PROJ_ID);
    printf("pathname = \"%s\"\n",PATHNAME);

    shmid = createId(PATHNAME,PROJ_ID,arg, server);

    /*attacher le segment a l'espace mémoire du client*/
    pShmMessage = (shm_message_t *)shmat(shmid , NULL , 0);
    if(pShmMessage < (shm_message_t *) 0){
      fprintf(stderr, " %s:%s:%d: Unable to attache the System V shared memory segment identified \"%d\" shmid. \n", arg,__FILE__,__LINE__,shmid);
      exit(1);
    }
    return pShmMessage;
}
